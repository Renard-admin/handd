<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–£–º–Ω–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ</title>
    <style>
        body { margin: 0; overflow: hidden; }
        #container { position: relative; width: 100vw; height: 100vh; }
        video, canvas { position: absolute; top: 0; left: 0; transform: scaleX(-1); }
        .canvas-layer { position: absolute; pointer-events: none; }
        .controls { position: fixed; top: 10px; right: 10px; z-index: 1000; }
        button { display: block; margin: 5px; padding: 8px; background: #444; color: white; border: none; cursor: pointer; }
    </style>
</head>
<body>
    <div id="container">
        <video id="video" autoplay playsinline></video>
        <canvas id="handCanvas" class="canvas-layer"></canvas>
        <canvas id="faceCanvas" class="canvas-layer"></canvas>
        <canvas id="objectCanvas" class="canvas-layer"></canvas>
        <div class="controls">
            <button id="fullscreenBtn">üì∫</button>
            <button id="switchCameraBtn">üîÑ –ö–∞–º–µ—Ä–∞</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.18.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <script>
        const video = document.getElementById('video');
        const handCanvas = document.getElementById('handCanvas');
        const faceCanvas = document.getElementById('faceCanvas');
        const objectCanvas = document.getElementById('objectCanvas');
        
        let isDrawing = false;
        let currentStream = null;
        let modelsLoaded = false;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–µ–π
        async function initializeModels() {
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri('/models'),
                faceapi.nets.ageGenderNet.loadFromUri('/models'),
                faceapi.nets.faceExpressionNet.loadFromUri('/models'),
                cocoSsd.load()
            ]);
            modelsLoaded = true;
        }

        // –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ
        async function setupCamera(facingMode = 'user') {
            const constraints = {
                video: { 
                    facingMode: facingMode,
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                if (currentStream) currentStream.getTracks().forEach(track => track.stop());
                currentStream = stream;
                video.srcObject = stream;
                await new Promise(resolve => video.onloadedmetadata = resolve);
                setupCanvases();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:', error);
            }
        }

        function setupCanvases() {
            [handCanvas, faceCanvas, objectCanvas].forEach(canvas => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
            });
        }

        // –õ–æ–≥–∏–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∂–µ—Å—Ç–æ–≤
        const hands = new Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });

        hands.setOptions({
            maxNumHands: 2,
            modelComplexity: 1,
            minDetectionConfidence: 0.7,
            minTrackingConfidence: 0.7
        });

        hands.onResults(processHands);

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤
        async function detectObjects() {
            if (!modelsLoaded) return;
            const predictions = await cocoSsd.detect(video);
            drawObjectPredictions(predictions);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª–∏—Ü
        async function detectFaces() {
            if (!modelsLoaded) return;
            const detections = await faceapi.detectAllFaces(video, 
                new faceapi.TinyFaceDetectorOptions())
                .withAgeAndGender()
                .withFaceExpressions();
            
            const ctx = faceCanvas.getContext('2d');
            ctx.clearRect(0, 0, faceCanvas.width, faceCanvas.height);
            
            detections.forEach(detection => {
                const box = detection.detection.box;
                ctx.strokeStyle = 'yellow';
                ctx.lineWidth = 2;
                ctx.strokeRect(box.x, box.y, box.width, box.height);
                
                // –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
                ctx.fillStyle = 'yellow';
                ctx.font = '12px Arial';
                const age = Math.round(detection.age);
                const gender = detection.gender;
                const expression = Object.entries(detection.expressions)
                    .reduce((a, b) => a[1] > b[1] ? a : b)[0];
                
                ctx.fillText(`${gender}, ~${age} –ª–µ—Ç`, box.x, box.y - 5);
                ctx.fillText(`–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: ${expression}`, box.x, box.y - 20);
            });
        }

        // –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏
        async function processFrame() {
            if (!modelsLoaded) return;
            
            await hands.send({ image: video });
            await detectFaces();
            await detectObjects();
            
            requestAnimationFrame(processFrame);
        }

        // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        document.getElementById('switchCameraBtn').addEventListener('click', async () => {
            const newMode = currentStream.getVideoTracks()[0].getSettings().facingMode === 'user' 
                ? 'environment' : 'user';
            await setupCamera(newMode);
        });

        document.getElementById('fullscreenBtn').addEventListener('click', () => {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        (async function main() {
            await initializeModels();
            await setupCamera();
            video.play();
            requestAnimationFrame(processFrame);
        })();
    </script>
</body>
</html>
